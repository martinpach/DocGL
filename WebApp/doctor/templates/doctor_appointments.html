<div class="row doctor-appointments">
    <h1 class="heading heading-appointments" id="heading">Appointments</h1>
    <div class="row">
        <div class="app-menu">
            <form>
                <input type="text" class="form-control datepicker" placeholder="day" id="day-input">
                <div class="btn-group" data-toggle="buttons">
                    <label class="btn btn-primary btn-appointments active">
                        <input type="radio" name="time_period" value="day" autocomplete="off" checked id="day-radio">Selected Day
                    </label>
                    <label class="btn btn-primary btn-appointments">
                        <input type="radio" name="time_period" value="week" autocomplete="off" id="week-radio">One week from the selected Day
                    </label>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="container contentTab z-depth-1" id="contentTab">
</div>
<div id="appointmentModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header text-center">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title headingModal">Appointment details</h4>
            </div>
            <div class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Done</button>
            </div>
        </div>
    </div>
</div>
<script>
var appointments;
var radioBtn = $('input[type=radio][name=time_period]');



$(radioBtn).change(function() {
    if ($('#day-input').val() != "") {
        if (this.value == "day") {
            $('#contentTab').empty();
            showDayAppointments($('#day-input').val());
        }
        if (this.value == "week") {
            $('#contentTab').empty();
            showWeeklyAppointments();
        }
    }
});
$('#day-input').change(function() {
    if ($('input[type=radio][name=time_period]:checked').val() == "day") {
        $('#contentTab').empty();
        showDayAppointments($('#day-input').val());
    }
    if ($('input[type=radio][name=time_period]:checked').val() == "week") {
        $('#contentTab').empty();
        showWeeklyAppointments();
    }
});

function showDayAppointments(date) {
    ajaxRequest("doctors/" + localStorage.getItem("id") + "/appointments?date=" + date, 'GET').done(function() {
        $(".appointment-day").remove();
        for (var i = 0; i < appointments.length; i++) {
            var appointmentBox = $('<div class="appointment-day"></div>');
            var appointmentTimeBox = $('<div class="time"></div>');
            var appointmentPatientBox = $('<div class="patient"></div>');
            var appointmentNoteBox = $('<p class="note"></p>');
            var btnCancelAppointment = $('<button type="button" class="btn btn-danger btn-sm btn-cancel-appointment" id="' + appointments[i].id + '">Cancel</button>');
            var colMd4 = $('<div class="col-md-4"></div>');
            appointmentTimeBox.text((appointments[i].time).substr(0, 5));
            appointmentPatientBox.text((appointments[i].patientFirstName == "" ? appointments[i].patient.firstName : appointments[i].patientFirstName) + " " + (appointments[i].patientLastName == "" ? appointments[i].patient.lastName : appointments[i].patientLastName));
            appointmentNoteBox.text(appointments[i].note);
            appointmentBox.append(appointmentTimeBox, appointmentPatientBox, appointmentNoteBox, btnCancelAppointment);
            appointmentBox.appendTo(colMd4);
            colMd4.appendTo('#contentTab');
        }
    });
}

function showWeeklyAppointments() {
    ajaxRequest("doctors/" + localStorage.getItem("id") + "/appointments?date=" + $('#day-input').val() + "&timePeriod=week", 'GET').done(function() {
        $(".appointment-day").remove();
        for (var i = 0; i < appointments.length; i++) {
            var appointmentBox = $('<div class="appointment-week"></div>').css('cursor', 'pointer');
            var appointmentDateBox = $('<div class="date"></div>');
            var appointmentCountBox = $('<div class="num-of-appointments"></div>');
            var colMd4 = $('<div class="col-md-4"></div>');
            appointmentDateBox.text(appointments[i].date);
            appointmentCountBox.text("Number of appointments: " + appointments[i].appointments);
            appointmentBox.append(appointmentDateBox, appointmentCountBox);
            appointmentBox.appendTo(colMd4);
            colMd4.appendTo('#contentTab');
        }
    });
}


$(function() {
    $(".datepicker").datepicker({
        dateFormat: "yy-mm-dd",
        defaultDate: getCurrentDate()
    }).val(getCurrentDate());
});

(function() {
    showDayAppointments(getCurrentDate());
})();

function getCurrentDate() {
    var d = new Date(),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;

    return [year, month, day].join('-');
}

function ajaxRequest(sufix, type) {
    var deferred = $.Deferred();
    $.ajax({
        beforeSend: function(xhr) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem("token"));
        },
        url: 'http://localhost:8085/api/' + sufix,
        type: type,
        contentType: 'application/json',
        success: function(data) {
            if (data !== undefined) {
                appointments = data;
                console.log(appointments);
            }
            deferred.resolve();
        },
        error: function() {
            deferred.reject();
        }
    });
    return deferred.promise();
}

$(document).on('click', '.appointment-week', function() {
    var date = $(this).find('.date').text();
    $('#week-radio').prop("checked", false);
    $('#day-radio').prop("checked", true);
    $('#day-input').val(date);
    $('#contentTab').empty();
    showDayAppointments(date);
    $('#contentTab').empty();
});

$(document).on('click', '.btn-cancel-appointment', function() {
    var appointmentId = $(this).attr('id');
    ajaxRequest("appointments/" + appointmentId, 'DELETE').done(function () {
        $('#contentTab').empty();    
        showDayAppointments($('#day-input').val());   
    });
});
</script>
